- name: Build per-folder ConfigMap data for selected env
  when: app.configmaps is defined
  set_fact:
    configmaps_data: {}

- name: Process each configmap folder
  when: app.configmaps is defined
  include_tasks: build_one_configmap.yml
  loop: "{{ app.configmaps }}"
  loop_control:
    loop_var: cm

---new file---
- set_fact:
    _cm_data: {}

- name: Read files from env folder
  set_fact:
    _cm_data: "{{ _cm_data | combine({ (p | basename): lookup('file', p) }) }}"
  loop: >-
    {{
      lookup(
        'fileglob',
        app_dir ~ '/' ~ app.name ~ '/configmap/' ~ cm.name ~ '/' ~ target_env ~ '/*',
        wantlist=True
      )
    }}
  loop_control:
    loop_var: p

- name: Store configmap data by name
  set_fact:
    configmaps_data: "{{ configmaps_data | combine({ cm.name: _cm_data }) }}"
